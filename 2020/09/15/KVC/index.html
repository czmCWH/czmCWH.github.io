<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="KVC"><meta name="keywords" content="iOS"><meta name="author" content="Czm"><meta name="copyright" content="Czm"><title>KVC | Czm</title><link rel="shortcut icon" href="/img/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#KVC基本概念"><span class="toc-number">1.</span> <span class="toc-text">KVC基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC的作用"><span class="toc-number">1.1.</span> <span class="toc-text">KVC的作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KVC可以执行的操作"><span class="toc-number">2.</span> <span class="toc-text">KVC可以执行的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC访问对象的属性"><span class="toc-number">2.1.</span> <span class="toc-text">KVC访问对象的属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用Key-和-key-path-标识对象的属性"><span class="toc-number">2.1.1.</span> <span class="toc-text">用Key 和 key path 标识对象的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-Key-设置属性值"><span class="toc-number">2.1.2.</span> <span class="toc-text">使用 Key 设置属性值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-Key-获取属性的值"><span class="toc-number">2.1.3.</span> <span class="toc-text">使用 Key 获取属性的值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC操作集合属性"><span class="toc-number">2.2.</span> <span class="toc-text">KVC操作集合属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用集合运算符"><span class="toc-number">2.3.</span> <span class="toc-text">使用集合运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Aggregation-Operators"><span class="toc-number">2.3.1.</span> <span class="toc-text">Aggregation Operators</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Array-Operators"><span class="toc-number">2.3.2.</span> <span class="toc-text">Array Operators</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nesting-Operators"><span class="toc-number">2.3.3.</span> <span class="toc-text">Nesting Operators</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问非对象属性"><span class="toc-number">2.4.</span> <span class="toc-text">访问非对象属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证属性"><span class="toc-number">2.5.</span> <span class="toc-text">验证属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问搜索模式"><span class="toc-number">2.6.</span> <span class="toc-text">访问搜索模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本的-Getter-搜索模式"><span class="toc-number">2.6.1.</span> <span class="toc-text">基本的 Getter 搜索模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基本的-Setter-搜索模式"><span class="toc-number">2.6.2.</span> <span class="toc-text">基本的 Setter 搜索模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KVC字典转模型"><span class="toc-number">3.</span> <span class="toc-text">KVC字典转模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#学习博客"><span class="toc-number">4.</span> <span class="toc-text">学习博客</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="avatar.jpeg"></div><div class="author-info__name text-center">Czm</div><div class="author-info__description text-center">学习记录</div><div class="follow-button"><a href="https://github.com/czmCWH" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">20</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">7</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://www.cnswift.org/about-swift" target="_blank" rel="noopener">swift中文文档</a><a class="author-info-links__name text-center" href="https://swift.gg" target="_blank" rel="noopener">SwiftGG</a><a class="author-info-links__name text-center" href="http://chuangzaoshi.com" target="_blank" rel="noopener">创造狮导航</a><a class="author-info-links__name text-center" href="http://lib.xcz.im/library" target="_blank" rel="noopener">《西窗烛》</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Czm</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/About">关于</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">KVC</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/Foundation/">Foundation</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="KVC基本概念"><a href="#KVC基本概念" class="headerlink" title="KVC基本概念"></a>KVC基本概念</h2><p><code>Key-Value Coding</code>(简称<code>KVC</code>)是由 <code>NSKeyValueCoding</code> 非正式协议启用的一种机制，对象采用这种机制来提供对 其属性的间接访问。</p>
<p>当对象符合<code>Key-Value Coding</code>标准时，可以通过简洁、统一的 消息传递接口 通过 字符串参数 访问其属性。这种间接访问机制补充了实例变量及其关联的访问器方法提供的直接访问。</p>
<a id="more"></a>

<p>以下代码是我们经常使用<code>KVC</code>进行的操作：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="built_in">NSInteger</span> price;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">ZMCar</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个ZMPerson类</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ZMPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@private</span></span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>)<span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)ZMCar *bus;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>)<span class="built_in">NSString</span> *sex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ZMPerson</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">float</span> _height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _sex = <span class="string">@"男生"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ZMCar *c = [[ZMCar alloc] init];</span><br><span class="line">ZMPerson *p = [[ZMPerson alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.KVC直接给对象的属性赋值,并且自动判断其类型</span></span><br><span class="line">[p setValue:<span class="string">@"zhangsan"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line">[c setValue:<span class="string">@"21$"</span> forKey:<span class="string">@"price"</span>];</span><br><span class="line">[p setValue:c forKey:<span class="string">@"bus"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//2.KVC设置私有实例变量、@private的实例变量的值、readonly属性修饰的变量</span></span><br><span class="line">[p setValue:<span class="string">@"22"</span> forKey:<span class="string">@"age"</span>];</span><br><span class="line">[p setValue:@<span class="number">170</span> forKey:<span class="string">@"_height"</span>];</span><br><span class="line">[p setValue:<span class="string">@"女生"</span> forKey:<span class="string">@"sex"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//3.KVC通过字典给对象赋值</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = @&#123;<span class="string">@"age"</span>:@<span class="number">33</span>, <span class="string">@"name"</span>:<span class="string">@"李四"</span>, <span class="string">@"bus"</span>:c, <span class="string">@"_height"</span>:<span class="string">@"180"</span>&#125;;</span><br><span class="line">[p setValuesForKeysWithDictionary:dict];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//4.KVC和数组,根据keyPath获取数组中对象的属性的值</span></span><br><span class="line">ZMCar *c1 = [[ZMCar alloc]init];</span><br><span class="line">c1.price =<span class="number">21</span>;</span><br><span class="line">ZMCar *c2 = [[ZMCar alloc]init];</span><br><span class="line">c2.price =<span class="number">22</span>;</span><br><span class="line">ZMCar *c3 = [[ZMCar alloc]init];</span><br><span class="line">c3.price =<span class="number">23</span>;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSArray</span> *arr = @[c1, c2, c3];</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSArray</span> *carPriceArr = [arr valueForKeyPath:<span class="string">@"price"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, carPriceArr);</span><br></pre></td></tr></table></figure>

<h3 id="KVC的作用"><a href="#KVC的作用" class="headerlink" title="KVC的作用"></a>KVC的作用</h3><p>通常，我们使用访问器方法访问对象的属性，如：<code>getter</code>方法 和 <code>setter</code>方法。在<code>Objective-C</code>中，也可以直接访问属性的底层实例变量。这些方式访问对象的属性都很简单，但需要调用特定于属性的方法或变量名。随着属性列表的增加或更改，访问这些属性的代码也必须随之增加，缺乏灵活性。相比之下，遵循 <code>Key-Value Coding</code> 的对象提供了一个简单的消息传递接口，该接口在其所有属性之间都是一致的。</p>
<p><code>Key-Value Coding</code> 是其他许多<code>Cocoa</code>技术的基础概念，如：<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177i" target="_blank" rel="noopener">Key-value-observation(KVO)</a>、<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CocoaBindings/CocoaBindings.html#//apple_ref/doc/uid/10000167i" target="_blank" rel="noopener">Cocoa bindings</a>、<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreData/index.html#//apple_ref/doc/uid/TP40001075" target="_blank" rel="noopener">Core Data</a>和 <a href="https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptX/AppleScriptX.html#//apple_ref/doc/uid/10000156i" target="_blank" rel="noopener">AppleScript-ability</a>。在某些情况下，<code>KVC</code>还可以帮助简化代码。</p>
<h2 id="KVC可以执行的操作"><a href="#KVC可以执行的操作" class="headerlink" title="KVC可以执行的操作"></a>KVC可以执行的操作</h2><p><code>NSObject</code> 采用了 <code>NSKeyValueCoding</code> 协议，并为基本方法提供了默认实现。这样继承自<code>NSObject</code>的对象使其他对象能够通过紧凑的消息传递接口执行以下操作：</p>
<ul>
<li><p>访问对象的属性</p>
</li>
<li><p>操作集合属性</p>
</li>
<li><p>在集合对象上调用集合运算符</p>
</li>
<li><p>访问非对象属性</p>
</li>
<li><p>通过<code>Key-Path</code>访问属性</p>
</li>
</ul>
<h3 id="KVC访问对象的属性"><a href="#KVC访问对象的属性" class="headerlink" title="KVC访问对象的属性"></a>KVC访问对象的属性</h3><h4 id="用Key-和-key-path-标识对象的属性"><a href="#用Key-和-key-path-标识对象的属性" class="headerlink" title="用Key 和 key path 标识对象的属性"></a>用<code>Key</code> 和 <code>key path</code> 标识对象的属性</h4><p>键(<code>Key</code>)是标识特定属性的字符串。通常，按照约定，表示属性的键是在代码中显示的属性本身的名称。</p>
<p>键路径(<code>key path</code>)是一系列点分隔的键(<code>Key</code>)，用于指定要遍历的对象(遵循<code>KVC</code>的层次结构对象)属性序列。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Key-设置属性值"><a href="#使用-Key-设置属性值" class="headerlink" title="使用 Key 设置属性值"></a>使用 Key 设置属性值</h4><ul>
<li><p><code>setValue:forKey:</code> 将指定<code>Key</code>相对于接收消息的对象的值设置为给定值。<br>如果指定 <code>Key</code> 的对应于接收<code>setter</code>调用的对象所不具有的属性，则该对象将向自身发送<code>setValue:forUndefinedKey:</code>消息。<code>setValue:forUndefinedKey:</code>的默认实现引发<code>NSUndefinedKeyException</code>异常，子类可以重写此方法以自定义方式处理请求。</p>
</li>
<li><p><code>setValue:forKeyPath:</code> 在相对于接收方指定<code>Key Path</code>处的设置给定值。<br><code>Key Path</code>序列中不符合特定<code>Key</code>的键值编码的任何对象都会收到<code>setValue:forUndefinedKey:</code>消息。</p>
</li>
<li><p><code>setValuesForKeysWithDictionary:</code> 使用字典<code>Key</code>标识属性，使用指定字典中的<code>Value</code>设置接收方的属性。<br>默认实现为字典的每个 键-值对 调用<code>setValue:forKey:</code>，并根据需要用<code>nil</code>替换<code>NSNull</code>对象。</p>
</li>
</ul>
<p>在默认实现中，当您尝试将一个<strong>非对象属性</strong>设置为<code>nil</code>值时，<code>KVC</code>对象会向自己发送一个<code>setNilValueForKey:</code>消息。<code>setNilValueForKey:</code>的默认实现会引发一个<code>NSInvalidArgumentException</code>异常，但对象可以重写这个方法来代替默认值或标记值，如处理非对象值中所描述的那样。</p>
<h4 id="使用-Key-获取属性的值"><a href="#使用-Key-获取属性的值" class="headerlink" title="使用 Key 获取属性的值"></a>使用 Key 获取属性的值</h4><ul>
<li><p><code>valueForKey:</code> 返回由<code>key</code>参数命名的属性的值。<br>如果无法找到由<code>Key</code>命名的属性，则<code>KVC</code>对象将向自己发送<code>valueForUndefinedKey:</code>消息，<code>valueForUndefinedKey:</code>的默认实现引发了一个<code>NSUndefinedKeyException</code>，子类通常重写此方法并更优雅的处理这种情况。</p>
</li>
<li><p><code>valueForKeyPath:</code> 返回相对于接收者的指定<code>Key Path</code>的值。<br>在<code>Key Path</code>序列中任何不符合<code>KVC</code>的对象，也就是说，<code>valueForKey:</code>的默认实现无法找到访问器方法，该对象均会接收到<code>valueForUndefinedKey:</code>消息。</p>
</li>
<li><p><code>dictionaryWithValuesForKeys:</code> 返回与接收器相关的键数组的值。<br>该方法为数组中的每个<code>Key</code>调用<code>valueForKey:</code>。 返回的<code>NSDictionary</code>包含数组中所有键的值。</p>
</li>
</ul>
<p>如下例子，访问对象的属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ZMPart</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>)<span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSArray</span> &lt;<span class="built_in">NSString</span> *&gt;*place;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ZMTool</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSNumber</span> *objCount;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)ZMPart *part;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSArray</span> &lt;<span class="built_in">UIColor</span> *&gt; *colors;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSArray</span> &lt;<span class="built_in">NSNumber</span> *&gt;*days;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[tool setValue:@<span class="number">2</span> forKey:<span class="string">@"objCount"</span>];</span><br><span class="line">[tool setValue:@[[<span class="built_in">UIColor</span> blueColor], [<span class="built_in">UIColor</span> redColor]] forKey:<span class="string">@"colors"</span>];</span><br><span class="line">[tool setValue:[[ZMPart alloc] init] forKey:<span class="string">@"part"</span>];</span><br><span class="line">[tool setValue:<span class="string">@"new_part"</span> forKeyPath:<span class="string">@"part.name"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@, %@, %@"</span>, [tool valueForKey:<span class="string">@"objCount"</span>], tool.colors, [tool valueForKeyPath:<span class="string">@"part.name"</span>]);</span><br><span class="line">    </span><br><span class="line">[tool setValuesForKeysWithDictionary:@&#123;<span class="string">@"objCount"</span>: @<span class="number">12</span>, <span class="string">@"colors"</span>:@[[<span class="built_in">UIColor</span> yellowColor]]&#125;];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [tool dictionaryWithValuesForKeys:@[<span class="string">@"objCount"</span>, <span class="string">@"colors"</span>]]);</span><br></pre></td></tr></table></figure>

<h3 id="KVC操作集合属性"><a href="#KVC操作集合属性" class="headerlink" title="KVC操作集合属性"></a>KVC操作集合属性</h3><p>符合 <code>KVC</code> 的对象，可以通过 其协议提供的方法来操作集合类型的属性内容。协议提供了如下方法：</p>
<ul>
<li><p><code>mutableArrayValueForKey:</code> 和 <code>mutableArrayValueForKeyPath:</code><br>返回行为类似于<code>NSMutableArray</code>对象的<strong>代理对象</strong>。</p>
</li>
<li><p><code>mutableSetValueForKey:</code> 和 <code>mutableSetValueForKeyPath:</code><br>返回行为类似于<code>NSMutableSet</code>对象的<strong>代理对象</strong>。</p>
</li>
<li><p><code>mutableOrderedSetValueForKey:</code> 和 <code>mutableOrderedSetValueForKeyPath:</code><br>返回行为类似于<code>NSMutableOrderedSet</code>对象的<strong>代理对象</strong>。</p>
</li>
</ul>
<p>通过如下例子来理解代理对象：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[tool setValue:@[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>] forKey:<span class="string">@"days"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [tool valueForKey:<span class="string">@"days"</span>]);   <span class="comment">// 打印：[1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过代理对象操作集合类型的属性：</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *days = [tool mutableArrayValueForKey:<span class="string">@"days"</span>];</span><br><span class="line">[days removeObject:@<span class="number">2</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [tool valueForKey:<span class="string">@"days"</span>]);   <span class="comment">// 打印：[1, 3]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[tool setValue:@[<span class="string">@"北京"</span>, <span class="string">@"河北"</span>] forKeyPath:<span class="string">@"part.place"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [tool valueForKeyPath:<span class="string">@"part.place"</span>]); <span class="comment">// 打印：["北京", "河北"] </span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutPlace = [tool mutableArrayValueForKeyPath:<span class="string">@"part.place"</span>];</span><br><span class="line">[mutPlace addObject:<span class="string">@"河南"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [tool valueForKeyPath:<span class="string">@"part.place"</span>]); <span class="comment">// 打印：["北京", "河北", "河南"]</span></span><br></pre></td></tr></table></figure>

<p>通过对<strong>代理对象</strong>进行操作集合的内容，协议的默认实现将相应地修改底层属性。这比<code>valueForKey:</code>获取不可变的集合对象，然后创建一个内容已修改的对象，最后使用<code>setValue:forKey:</code>存回更有效。</p>
<p>这些方法的另一个好处是可以维护集合对象中保存的对象的<code>KVO</code>遵从性。</p>
<h3 id="使用集合运算符"><a href="#使用集合运算符" class="headerlink" title="使用集合运算符"></a>使用集合运算符</h3><p>当向符合<code>KVC</code>的对象发送 <code>valueForKeyPath:</code>消息时，可以在 <code>Key-Path</code> 中嵌入 <strong>集合运算符</strong>。</p>
<p>集合运算符(<code>Collection Operators</code>)是前面带有一个<code>@符号</code>一小串关键字中的一个，它指定了<code>getter</code>在返回数据之前应该执行的操作，以某种方式对数据进行操作。<code>NSObject</code>默认实现实现了此行为。</p>
<p>当<code>Key-Path</code>包含集合运算符时，使用格式如下：</p>
<p><img src="media/15731078774706/keypath.jpg" alt="keypath"></p>
<ul>
<li><p><code>Left Key Path</code>：称为左键路径，它指集合运算符之前的<code>Key-Path</code>的任何部分，指示相对于消息接收方要操作的集合。如果将消息直接发送给一个集合对象，比如<code>NSArray</code>实例，则可能会省略左键路径。</p>
</li>
<li><p><code>Right Key Path</code>：称为右键路径，它指集合运算符后面的<code>Key-Path</code>部分，指定了该运算符应处理的集合中的属性。除<code>@count</code>之外的所有集合运算符都需要一个正确的<code>Key-Path</code>。</p>
</li>
</ul>
<p><code>Collection Operators</code>的三种基本行为类型：</p>
<ol>
<li><code>Aggregation Operators</code>(聚合运算符)，以某种方式合并集合对象，并返回一个通常与右键路径中指定的属性的数据类型匹配的单个对象。<code>@count</code>运算符符是个例外，它不接受右键路径，并且总是返回一个<code>NSNumber</code>实例。</li>
<li><code>Array Operators</code>(数组运算符)，返回一个NSArray实例，该实例包含命名集合中包含的某些对象子集。</li>
<li><code>Nesting Operators</code>(嵌套运算符)，在包含其他集合的集合上工作，并根据运算符返回<code>NSArray</code>或<code>NSSet</code>实例，该实例以某种方式组合嵌套集合的对象。</li>
</ol>
<p>下面例子均使用以下对象进行：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>)<span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSNumber</span> *age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSDate</span> *birthday;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)personWithDict:(<span class="built_in">NSDictionary</span> *)dict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithDict:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setValuesForKeysWithDictionary:dict];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)personWithDict:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithDict:dict];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"😭😭😭😭未找到key: %@"</span>, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="Aggregation-Operators"><a href="#Aggregation-Operators" class="headerlink" title="Aggregation Operators"></a>Aggregation Operators</h4><p><strong>聚合运算符</strong> 用于处理数组或属性集，生成反映集合某些方面的单个值。</p>
<ul>
<li><p><code>@avg</code>运算符，<code>valueForKeyPath:</code>读取集合中每个元素的右键路径指定的属性，将其转换为双精度值(用0替换nil值)，并计算这些值的算术平均值。然后返回存储在<code>NSNumber</code>实例中的结果。</p>
</li>
<li><p><code>@count</code>运算符，<code>valueForKeyPath:</code>返回<code>NSNumber</code>实例中集合中的对象数量。如果存在<code>right key path</code>将被忽略。</p>
</li>
<li><p><code>@max</code>运算符，<code>valueForKeyPath:</code>在由右键路径命名的集合项中搜索并返回最大的项。搜索使用<code>Foundation</code>中的<code>compare:</code>方法进行比较，因此，右键路径所指示的属性必须包含对该方法有意义响应的对象。</p>
</li>
<li><p><code>@min</code>运算符，与<code>@max</code>运算符相反。</p>
</li>
<li><p><code>@sum</code>运算符，<code>valueForKeyPath:</code>读取由右键路径为集合的每个元素指定的属性，将其转换为<code>double</code>（用0代替<code>nil</code>值），并计算这些值的总和。将结果返回存储在<code>NSNumber</code>实例中。</p>
</li>
</ul>
<p>基本使用如下例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.peoples = @[[Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"张三"</span>, <span class="string">@"age"</span>:@<span class="number">18</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-02-22"</span>&#125;],</span><br><span class="line">                 [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"李四"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">                 [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"李四"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">                 [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"赵六"</span>, <span class="string">@"age"</span>:@<span class="number">19</span>, <span class="string">@"birthday"</span>:<span class="string">@"1998-03-23"</span>&#125;]</span><br><span class="line">                ];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSNumber</span> *average = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@avg.age"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, average);  <span class="comment">// 打印：20.25</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSNumber</span> *number = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@count"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, number);  <span class="comment">// 打印：4</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSDate</span> *max = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@max.birthday"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, max);   <span class="comment">// 打印： 2001-02-22</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSDate</span> *min = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@min.birthday"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, min);   <span class="comment">// 打印： 1998-03-23</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSNumber</span> *sum = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@sum.age"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, sum);  <span class="comment">// 打印：81</span></span><br></pre></td></tr></table></figure>

<h4 id="Array-Operators"><a href="#Array-Operators" class="headerlink" title="Array Operators"></a>Array Operators</h4><p><strong>数组运算符</strong> 使<code>valueForKeyPath:</code>返回一个对象数组，该对象数组与右键路径指示的一组特定对象相对应。</p>
<blockquote>
<p>如果使用数组运算符时有任何子对象为<code>nil</code>，则<code>valueForKeyPath:</code>方法将引发异常。</p>
</blockquote>
<ul>
<li><p><code>@distinctUnionOfObjects</code>运算符，<code>valueForKeyPath:</code>创建并返回一个数组，该数组包含集合中与由右键路径指定的属性相对应的不重复对象。</p>
</li>
<li><p><code>@unionOfObjects</code>运算符，与<code>@distinctUnionOfObjects</code>类似，但是返回的数组没有删除重复的对象。</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *distinct = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@distinctUnionOfObjects.name"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"去掉重复：%@"</span>, distinct);  <span class="comment">// 打印：去掉重复：["赵六", "张三", "李四"]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *unionNames = [<span class="keyword">self</span>.peoples valueForKeyPath:<span class="string">@"@unionOfObjects.name"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"获取所有：%@"</span>, unionNames);  <span class="comment">// 打印：获取所有：["张三", "李四", "李四", "赵六"]</span></span><br></pre></td></tr></table></figure>

<h4 id="Nesting-Operators"><a href="#Nesting-Operators" class="headerlink" title="Nesting Operators"></a>Nesting Operators</h4><p><strong>嵌套运算符</strong> 对嵌套的集合进行操作，其中集合本身的每个条目都包含一个集合。</p>
<blockquote>
<p>使用嵌套运算符时，如果任何叶子对象为<code>nil</code>，则 <code>valueForKeyPath:</code> 方法将引发异常。</p>
</blockquote>
<ul>
<li><p><code>@distinctUnionOfArrays</code>运算符，<code>valueForKeyPath:</code>创建并返回一个数组，该数组包含与右键路径指定的属性相对应的所有集合的组合的不重复的对象。</p>
</li>
<li><p><code>@unionOfArrays</code>运算符，与<code>@distinctUnionOfArrays</code> 运算符类似，但不会删除重复的对象。</p>
</li>
<li><p><code>@distinctUnionOfSets</code>运算符，<code>valueForKeyPath:</code>创建并返回一个<code>NSSet</code>对象，该对象包含与右键路径指定的属性相对应的所有集合的组合的不重复的对象。但是它要求操作的是的<code>NSSet</code>类型的实例。</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.boy = @[[Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"张三"</span>, <span class="string">@"age"</span>:@<span class="number">18</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-02-22"</span>&#125;],</span><br><span class="line">              [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"李四"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">              [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"李四"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">              [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"赵六"</span>, <span class="string">@"age"</span>:@<span class="number">19</span>, <span class="string">@"birthday"</span>:<span class="string">@"1998-03-23"</span>&#125;]</span><br><span class="line">            ];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">self</span>.girl = @[[Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"小红"</span>, <span class="string">@"age"</span>:@<span class="number">18</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-02-22"</span>&#125;],</span><br><span class="line">               [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"小红"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">               [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"小翠"</span>, <span class="string">@"age"</span>:@<span class="number">22</span>, <span class="string">@"birthday"</span>:<span class="string">@"2001-01-23"</span>&#125;],</span><br><span class="line">               [Person personWithDict:@&#123;<span class="string">@"name"</span>:<span class="string">@"小丹"</span>, <span class="string">@"age"</span>:@<span class="number">19</span>, <span class="string">@"birthday"</span>:<span class="string">@"1998-03-23"</span>&#125;]</span><br><span class="line">            ];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *somePeople = @[<span class="keyword">self</span>.boy, <span class="keyword">self</span>.girl];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *distinctArr = [somePeople valueForKeyPath:<span class="string">@"@distinctUnionOfArrays.birthday"</span>];</span><br><span class="line"><span class="comment">// 打印：去掉n个数组中重复：[1998-03-23, 2001-01-23, 2001-02-22]</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"去掉n个数组中重复：%@"</span>, distinctArr);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *unionArr = [somePeople valueForKeyPath:<span class="string">@"@unionOfArrays.birthday"</span>];</span><br><span class="line"><span class="comment">// 打印：获取n个数组中所有：[2001-02-22, 2001-01-23, 2001-01-23, 1998-03-23, 2001-02-22, 2001-01-23, 2001-01-23,1998-03-23]</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"获取n个数组中所有：%@"</span>, unionArr);</span><br></pre></td></tr></table></figure>


<h3 id="访问非对象属性"><a href="#访问非对象属性" class="headerlink" title="访问非对象属性"></a>访问非对象属性</h3><p><code>NSObject</code>遵守<code>KVC</code>协议的方法默认实现可以同时处理对象(<code>object</code>)和非对象(<code>non-object</code>)属性。默认实现在 对象参数 或 返回值 与 非对象属性 之间自动转换。</p>
<p><code>non-object properties</code>分为两类，一类是基本数据类型(<code>int、float、Bool...</code>)也就是所谓的<strong>标量</strong>(<code>scalar</code>)，一类是<strong>结构体</strong>(<code>struct</code>)。</p>
<ul>
<li><p>当使用<code>KVC</code>协议中的一个取值方法(如：<code>valueForKey:</code>)时，如果返回值不是一个对象，<code>getter</code>使用这个值来初始化一个<code>NSNumber</code>对象(用于标量)或<code>NSValue</code>对象(用于结构体)，然后返回该值。</p>
</li>
<li><p>在使用<code>setValue:forKey:</code>之类的设置器，给定特定键的情况下，如果数据类型不是对象，那么<code>setter</code>首先向传入的<code>Value</code>对象发送适当的<code>&lt;type&gt;Value</code>消息，以提取底层数据，并将其存储起来。</p>
</li>
<li><p>对非对象属性使用<code>nil</code>值调用一个<code>KVC</code>协议设置器时，它会向接收<code>setter</code>调用的对象发送一个<code>setNilValueForKey:</code>消息。这个方法的默认实现会引发一个<code>NSInvalidArgumentException</code>异常，一般子类可能会覆盖这个行为。</p>
</li>
</ul>
<p>下面例子演示了利用<code>KVC</code>对<code>non-object properties</code>(非对象属性)的访问：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">float</span> x, y, z;</span><br><span class="line">&#125; ThreePoint;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyScalar</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="keyword">float</span> num;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="built_in">BOOL</span> result;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="built_in">CGPoint</span> point;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSNumber</span> *count;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="keyword">int</span> total;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)ThreePoint threePt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">MyScalar *scalar = [[MyScalar alloc] init];</span><br></pre></td></tr></table></figure>

<p>使用<code>NSNumber</code>实例包装的标量类型，<code>NSValue</code>封装结构体类型。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[scalar setValue:[<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.25</span>] forKey:<span class="string">@"num"</span>];</span><br><span class="line"><span class="built_in">NSNumber</span> *num = [scalar valueForKey:<span class="string">@"num"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%0.2f, %@"</span>, num.floatValue, [num <span class="keyword">class</span>]);   <span class="comment">// 0.25, __NSCFNumber</span></span><br><span class="line">    </span><br><span class="line">[scalar setValue:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">false</span>] forKey:<span class="string">@"result"</span>];</span><br><span class="line"><span class="built_in">NSNumber</span> *result = [scalar valueForKey:<span class="string">@"result"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d, %@"</span>, result.boolValue, [result <span class="keyword">class</span>]);  <span class="comment">// 0, __NSCFBoolean</span></span><br><span class="line">    </span><br><span class="line">[scalar setValue:[<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">50.0</span>, <span class="number">50.0</span>)] forKey:<span class="string">@"point"</span>];</span><br><span class="line"><span class="built_in">NSValue</span> *point = [scalar valueForKey:<span class="string">@"point"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@, %@"</span>, <span class="built_in">NSStringFromCGPoint</span>(point.CGPointValue), [point <span class="keyword">class</span>]);   <span class="comment">// &#123;50, 50&#125;, NSConcreteValue</span></span><br></pre></td></tr></table></figure>
<p>通过<code>KVC</code>把非对象属性设置为<code>nil</code>，会向<code>KVC</code>对象发送<code>setNilValueForKey:</code>消息，并抛出异常：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[scalar setValue:<span class="literal">nil</span> forKey:<span class="string">@"count"</span>];</span><br><span class="line"><span class="built_in">NSNumber</span> *count = [scalar valueForKey:<span class="string">@"count"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"😄 %@"</span>, count);     <span class="comment">// 😄 (null)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// [scalar setValue:nil forKey:@"total"];  // 抛异常Terminating app due to uncaught exception 'NSInvalidArgumentException'</span></span><br><span class="line"><span class="built_in">NSNumber</span> *total = [scalar valueForKey:<span class="string">@"total"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"😭 %@"</span>, total);     <span class="comment">// 😭 0</span></span><br></pre></td></tr></table></figure>
<p>利用<code>KVC</code>访问自定义<code>struct</code>类型的属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ThreePoint three = &#123;<span class="number">1.2</span>, <span class="number">2.2</span>, <span class="number">2.3</span>&#125;;</span><br><span class="line"><span class="built_in">NSValue</span> *value = [<span class="built_in">NSValue</span> valueWithBytes:&amp;three objCType:<span class="keyword">@encode</span>(ThreePoint)];</span><br><span class="line">[scalar setValue:value forKey:<span class="string">@"threePt"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSValue</span> *threePt = [scalar valueForKey:<span class="string">@"threePt"</span>];</span><br><span class="line">ThreePoint getThree;</span><br><span class="line">[threePt getValue:&amp;getThree];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%0.2f, %0.2f, %0.2f, %@"</span>, getThree.x, getThree.y, getThree.z, [threePt <span class="keyword">class</span>]); <span class="comment">// 1.20, 2.20, 2.30, NSConcreteValue</span></span><br></pre></td></tr></table></figure>

<h3 id="验证属性"><a href="#验证属性" class="headerlink" title="验证属性"></a>验证属性</h3><p><code>KVC</code>的协议中定义了支持属性验证的方法，即对属性值的合法性进行校验，通过如下两个方法实现的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span>  _Nullable __autoreleasing *)ioValue</span><br><span class="line">               forKey:(<span class="built_in">NSString</span> *)inKey</span><br><span class="line">                error:(<span class="keyword">out</span> <span class="built_in">NSError</span> *__autoreleasing  _Nullable *)outError</span><br><span class="line">                </span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span>  _Nullable __autoreleasing *)ioValue</span><br><span class="line">           forKeyPath:(<span class="built_in">NSString</span> *)inKeyPath</span><br><span class="line">                error:(<span class="keyword">out</span> <span class="built_in">NSError</span> *__autoreleasing  _Nullable *)outError</span><br></pre></td></tr></table></figure>

<p>当你调用上面的验证方法时，<code>KVO</code>的默认实现将在接收验证消息的对象(或<code>keyPath</code>中最后的对象)中搜索一种方法，其方法名与<code>validate&lt;Key&gt;:error:</code>模式匹配。</p>
<ul>
<li>如果对象没有这样的方法，则默认验证成功，返回<code>YES</code>。</li>
<li>当特定于属性的验证方法(<code>validate&lt;Key&gt;:error:</code>)存在时，默认实现将返回调用该方法的结果。</li>
</ul>
<p>由于<code>validate&lt;Key&gt;:error:</code>方法通过引用接收值(<code>value</code>)和错误参数(<code>error</code>)，因此验证有三种可能的结果：</p>
<ul>
<li>验证方法认为<code>value</code>有效，并返回<code>YES</code>，而不改变<code>value</code>或<code>error</code>。</li>
<li>验证方法认为<code>value</code>无效，但并不修改它，返回<code>NO</code>，并将<code>error</code>设置为<code>NSError</code>对象。</li>
<li>验证方法认为<code>value</code>无效，创建一个新的有效对象替换<code>value</code>。方法返回<code>YES</code>，同时保持error对象不变。</li>
</ul>
<p>如下面例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyValidate</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>)<span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyValidate</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证属性 name  的值是否为 `admin`</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateName:(<span class="keyword">inout</span> <span class="keyword">id</span> *)value error:(<span class="keyword">out</span> <span class="built_in">NSError</span> *__autoreleasing  _Nullable *)outError &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *name = *value;</span><br><span class="line">    <span class="built_in">BOOL</span> res = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"admin"</span>]) &#123;</span><br><span class="line">        res = <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//        NSError *err = [[NSError alloc] initWithDomain:NSCocoaErrorDomain code:100 userInfo:@&#123;NSLocalizedDescriptionKey:@"描述：设置name值不符合要求",</span></span><br><span class="line"><span class="comment">//                       NSLocalizedFailureReasonErrorKey:@"原因：name的值必须为admin",</span></span><br><span class="line"><span class="comment">//                       NSLocalizedRecoverySuggestionErrorKey:@"建议：修改name的值"&#125;];</span></span><br><span class="line"><span class="comment">//        res = NO;</span></span><br><span class="line"><span class="comment">//        *outError = err;</span></span><br><span class="line"></span><br><span class="line">        *value = <span class="string">@"admin"</span>;</span><br><span class="line">        res = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MyValidate *obj = [[MyValidate alloc] init];</span><br><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"><span class="built_in">NSString</span> *value = <span class="string">@"tom"</span>;</span><br><span class="line"><span class="built_in">BOOL</span> res = [obj validateValue:&amp;value forKey:<span class="string">@"name"</span> error:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (res) &#123;</span><br><span class="line">    [obj setValue:value forKey:<span class="string">@"name"</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d, %@, %@, %@"</span>, res, value, error, [obj valueForKey:<span class="string">@"name"</span>]);  <span class="comment">// 1, admin, (null), admin</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通常，<code>KVC</code>的默认实现都没有定义任何自动执行验证的机制，一般我们在合适的地方提供验证方法。</p>
<p>通常，仅在<code>Objective-C</code>中使用此处描述的验证在<code>Swift</code>中，属性验证更习惯地通过依赖编译器对 <code>Optional</code> 和 强类型 检查的支持来处理，而使用<code>willSet</code> 和 <code>didSet</code>来测试运行时API的约定。</p>
</blockquote>
<h3 id="访问搜索模式"><a href="#访问搜索模式" class="headerlink" title="访问搜索模式"></a>访问搜索模式</h3><p><code>NSObject</code>提供的<code>NSKeyValueCoding</code>协议的默认实现，使用一组明确定义的规则将基于键(<code>Key</code>)的访问器调用映射到对象的底层属性。这些协议方法使用一个键(<code>Key</code>)参数在自己的对象实例中搜索访问器、实例变量 和 遵循特定命名约定的相关方法。</p>
<p>尽管您很少修改这种默认搜索，但是理解它是如何工作的还是很有帮助的，这有助于跟踪<code>KVC</code>对象的行为，也有助于使你自己的对象兼容。</p>
<p>通过<code>KVC</code>间接访问对象的属性，其取值(<code>getter</code>)和赋值(<code>setter</code>)的工作过程如下：</p>
<h4 id="基本的-Getter-搜索模式"><a href="#基本的-Getter-搜索模式" class="headerlink" title="基本的 Getter 搜索模式"></a>基本的 Getter 搜索模式</h4><p>执行<code>valueForKey:</code>时，在该方法调用类实例中默认进行以下操作：<br>1、 按顺序在实例中搜索第一个名为<code>get&lt;Key&gt;</code>、<code>&lt;Key&gt;</code>、<code>is&lt;Key&gt;</code>或<code>_&lt;Key&gt;</code>的访问器方法。如果找到了，就调用它，并继续执行<strong>步骤5</strong>。否则执行步骤2。</p>
<p>2、 如果找不到简单的访问器方法，则在实例中搜索<code>countOf&lt;Key&gt;</code>和<code>objectIn&lt;Key&gt;AtIndex:</code>(对应于<code>NSArray</code>定义的基本方法)和<code>&lt;Key&gt;AtIndexes:</code>(对应于<code>NSArray</code>方法<code>objectsAtIndexes:</code>)匹配的方法。</p>
<ul>
<li><p>如果找到其中第一个(<code>countOf&lt;Key&gt;</code>)，以及后面两个方法中的至少一个，则创建一个响应所有<code>NSArray</code>方法的集合代理对象，并返回该对象。否则，继续执行<strong>步骤3</strong>。</p>
</li>
<li><p>该代理对象会将它接收到的任何<code>NSArray</code>消息转换为<code>countOf&lt;Key&gt;</code>、<code>objectIn&lt;Key&gt;AtIndex:</code> 和 <code>&lt;Key&gt;AtIndex:</code>消息的某种组合，组合将消息发送给创建它的<code>KVC</code>对象。如果原始对象还实现了<code>get&lt;Key&gt;:range:</code>方法，那么代理对象也将在适当的时候使用该方法。代理对象和<code>KVC</code>对象一起使用，使底层属性的行为像<code>NSArray</code>一样工作，即使它不是。</p>
</li>
</ul>
<p>3、  如果找不到简单的访问器方法和数组访问方法，则查找<code>countOf&lt;Key&gt;</code>、<code>enumeratorOf&lt;Key&gt;</code> 和 <code>memberOf&lt;Key&gt;:</code>(对应于<code>NSSet</code>类定义的基本方法)。</p>
<ul>
<li>如果这三个方法都找到了，则创建一个响应所有<code>NSSet</code>方法的集合代理对象，并返回该对象。否则，执行<strong>步骤4</strong>。</li>
<li>该代理对象随后将接收到的所有<code>NSSet</code>消息转换为<code>countOf&lt;Key&gt;</code>、<code>enumeratorOf&lt;Key&gt;</code> 和 <code>memberOf&lt;Key&gt;:</code>消息的某种组合，并发送给创建它的对象。代理对象与<code>KVC</code>对象一起工作，使底层属性像<code>NSSet</code>一样运行，即使它不是<code>NSSet</code>。</li>
</ul>
<p>4、如果没有找到简单的访问方法或集合访问方法组，并且接收者的类方法<code>accessInstanceVariablesDirectly</code>返回<code>YES</code>。则按顺序搜索名为<code>_&lt;key&gt;</code>、<code>_is&lt;Key&gt;</code>、<code>&lt;key&gt;</code>、<code>is&lt;Key&gt;</code>的实例变量。</p>
<ul>
<li>如果找到，直接获取实例变量的值，然后执行<strong>步骤5</strong>；否则执行<strong>步骤6</strong>。</li>
</ul>
<p>5、如果检索到的属性值是一个对象指针，只需返回结果。<br>如果值是<code>NSNumber</code>支持的标量类型，将其存储在<code>NSNumber</code>实例中并返回。<br>如果结果是<code>NSNumber</code>不支持的标量类型，转换为<code>NSValue</code>对象并返回它。</p>
<p>6、如果所有其他方法都失败，则调用<code>valueForUndefinedKey:</code>。这在默认情况下会引发一个异常，但是<code>NSObject</code>的一个子类可能提供特定于键的行为。</p>
<p>下面例子演示了上面的执行步骤：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyValidate</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *_funName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyValidate</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        _funName = <span class="string">@"ABC"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤1</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)getNum &#123;</span><br><span class="line">    <span class="keyword">return</span> @<span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNum:(<span class="built_in">NSNumber</span> *)num &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2</span></span><br><span class="line"><span class="comment">// 决定代理数组元素的个数</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfArr &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该方法返回值依次作为代理数组的元素</span></span><br><span class="line"><span class="comment">// [ [123,], [456,], [???,] ]</span></span><br><span class="line"><span class="comment">//- (NSArray *)objectInArrAtIndex:(NSUInteger)index &#123;</span></span><br><span class="line"><span class="comment">//    switch (index) &#123;</span></span><br><span class="line"><span class="comment">//        case 0: return @[@"123"];</span></span><br><span class="line"><span class="comment">//        case 1: return @[@"456"];</span></span><br><span class="line"><span class="comment">//        default:  return @[@"???"];</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果未实现 objectIn&lt;Key&gt;AtIndex: 则此方法会被调用，返回值为数组类型，依次取该数组的第一个元素作为代理数组的元素</span></span><br><span class="line"><span class="comment">// [123, 456, ???]</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)arrAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes &#123;</span><br><span class="line">    <span class="keyword">switch</span> (indexes.firstIndex) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> @[<span class="string">@"123"</span>, <span class="string">@"a"</span>];</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> @[<span class="string">@"456"</span>, <span class="string">@"b"</span>];</span><br><span class="line">        <span class="keyword">default</span>:  <span class="keyword">return</span> @[<span class="string">@"???"</span>, <span class="string">@"c"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfAnimal &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值必须为 NSEnumerator 类型的枚举器，元素个数与 countOfAnimal 必须对应</span></span><br><span class="line">- (<span class="built_in">NSEnumerator</span> *)enumeratorOfAnimal &#123;</span><br><span class="line">    <span class="built_in">NSSet</span> *set = [[<span class="built_in">NSSet</span> alloc] initWithObjects:<span class="string">@"abc"</span>,<span class="string">@"123"</span>, <span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSEnumerator</span> *enumerator = [set objectEnumerator];</span><br><span class="line">    <span class="keyword">return</span> enumerator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)memberOfAnimal:(<span class="keyword">id</span>)index &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@"xxx"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤4</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)accessInstanceVariablesDirectly &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"👉 %@"</span>, [obj valueForKey:<span class="string">@"num"</span>]);  <span class="comment">// 👉 123</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"👉 %@"</span>, [obj valueForKey:<span class="string">@"arr"</span>]);  <span class="comment">//👉 [123,456,???,]</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"👉 %@"</span>, [obj valueForKey:<span class="string">@"animal"</span>]);   <span class="comment">// 👉 &#123;(abc, 123)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"👉 %@"</span>, [obj valueForKey:<span class="string">@"funName"</span>]);  <span class="comment">// 👉 ABC</span></span><br></pre></td></tr></table></figure>

<h4 id="基本的-Setter-搜索模式"><a href="#基本的-Setter-搜索模式" class="headerlink" title="基本的 Setter 搜索模式"></a>基本的 Setter 搜索模式</h4><p><code>setValue:forKey:</code>的默认实现，给定<code>key</code>和<code>value</code>作为参数输入，尝试在<code>KVC</code>对象内部设置一个名为<code>key</code>的属性为<code>value</code>(或者，对于非对象属性，为<code>value</code>的解包装版本)，执行以下过程:</p>
<p>1、按顺序查找名为<code>set&lt;Key&gt;:</code>、<code>_set&lt;Key&gt;</code>的第一个访问器。如果找到，将<code>value</code>(或根据需要解包值)传入调用。否则，执行步骤2。</p>
<p>2、如果没有找到简单的访问器，并且类方法<code>accessInstanceVariablesDirectly</code>返回值为<code>YES</code>，则依次按名次 <code>_&lt;key&gt;</code>、<code>_is&lt;Key&gt;</code>、<code>&lt;key&gt;</code>、<code>is&lt;Key&gt;</code> 查找一个实例变量。如果找到，直接用输入值<code>value</code>（或展开值）设置变量并完成操作。</p>
<p>3、在没有找到访问器或实例变量时，则会调用<code>setValue:forUndefinedKey:</code>，这在默认情况下会引发一个异常，但是<code>NSObject</code>的一个子类可能提供特定于键的行为。</p>
<p>KVC 键值编码：是一种间接修改/读取对象属性的一种方法，kvc被称为cocoa的大招。在Apple 官方文档中，通过 Key-value coding 进行搜索。</p>
<blockquote>
<p>有兴趣可以学习Apple官方文档中，关于 <code>Mutable Array</code>、<code>Mutable Ordered Set</code>、<code>Mutable Set</code>的搜索模式。</p>
</blockquote>
<h2 id="KVC字典转模型"><a href="#KVC字典转模型" class="headerlink" title="KVC字典转模型"></a>KVC字典转模型</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Status</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="built_in">NSInteger</span> ID;  <span class="comment">// 用ID来接收字典中的id</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *source;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> reposts_count;</span><br><span class="line"></span><br><span class="line">+ (__kindof Status *)statusWithDict:(<span class="built_in">NSDictionary</span> *)dict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Status</span></span></span><br><span class="line"><span class="comment">//kvc实现字典转模型</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithDict:(<span class="built_in">NSDictionary</span> *)dict&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setValuesForKeysWithDictionary:dict];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (__kindof Status *)statusWithDict:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc]initWithDict:dict];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 避免保证未找到key时，抛出异常程序崩溃</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"id"</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.ID = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"为找到key=%@"</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>通过<code>KVC</code>来实现字典转模型，其原理是先拿出字典里的<code>Key</code>查找模型中的属性名，若找不到则会调用 <code>setValue:forUndefinedKey:</code> 方法默认抛出异常。</p>
<h2 id="学习博客"><a href="#学习博客" class="headerlink" title="学习博客"></a>学习博客</h2><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/index.html" target="_blank" rel="noopener">About Key-Value Coding</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/Introduction.html#//apple_ref/doc/uid/TP40008195-CH68-DontLinkElementID_2" target="_blank" rel="noopener">Cocoa Core Competencies</a></p>
<p><a href="https://cainluo.github.io/2017/08/03/f1a2a035.html" target="_blank" rel="noopener">耍耍iOS中的KVC</a></p>
<p><a href="http://leejunhui.com/2020/02/15/iOS-底层探索-KVC/" target="_blank" rel="noopener">iOS 底层探索 - KVC</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Czm</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/09/15/KVC/">http://yoursite.com/2020/09/15/KVC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Czm</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/09/15/KVO/"><i class="fa fa-chevron-left">  </i><span>KVO</span></a></div><div class="next-post pull-right"><a href="/2020/09/10/UIBezierPath/"><span>UIBezierPath</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Czm</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>